---
name: Dev-WebAzure-AddServiceDesign
description: サービス定義書の「外部依存・統合」から、追加で必要な Azure サービス（AI/認証/統合/運用等）を選定し、根拠（Microsoft Learn）付きで記録する
# tools はリポジトリ設定・MCP名に依存します。MCP サーバー名が "MicrosoftDocs" であることが確実なら "MicrosoftDocs/*" を推奨。
# 不確実な間は "*" でも可。ただし本文ルールで「必要時のみ」を強制すること。
tools: ["*"]
---

1. [Goal]目的の理解

   * 1.1 # 重要：共通ルール

     * 本リポジトリの共通運用（Plannerを最初に出す、10分超なら分割、べき等性、再試行、変更要約など）は `.github\agents\AGENTS.md` に従う。
     * 不足情報があれば質問は最大3つ。ID/URL/固有名/数値の捏造は禁止。前提は明示。
     * 出力は日本語。見出し＋箇条書き中心で簡潔に。
     * 常駐情報とテンプレは `docs\templates\agent-playbook.md` を参照（必要なときだけ）。
     * 以降は「このStep固有」の追加指示のみを書く（重複禁止）。
     * 上記と矛盾する指示をこのファイルに追加しない。

   * 1.2 # 目的（このStepの成果物）

     * 入力ドキュメントを読み、「外部依存・統合」要件から **追加で必要な Azure サービス**を決定する。
     * 既にデプロイ済み（既存採用済み）の Azure サービスは **提案対象から除外**する（ただし依存関係として参照は可）。
     * 各決定について **Microsoft Learn（MicrosoftDocs MCP）根拠を最低1件**残す（タイトル/URL/要点）。

   * 1.3 # 入力（必読）

     * ユースケースID: {ユースケースID}
     * ユースケース: `docs/usecase/{ユースケースID}/usecase-description.md`
     * サービス一覧: `docs/usecase/{ユースケースID}/services/service-list.md`
     * 各サービス定義書: `docs/usecase/{ユースケースID}/services/{サービスID}-{サービス名}-description.md`
     * 既存採用済み（除外用）:

       * `docs/usecase/{ユースケースID}/AzureServices-services.md`
       * `docs/usecase/{ユースケースID}/AzureServices-data.md`

   * 1.4 # 出力（必須）

     1. 追加サービス設計（本成果物）

     * `docs/usecase/{ユースケースID}/AzureServices-services-additional.md`

     2. 進捗ログ（追記）

     * `work/{ユースケースID}/additional-azureservices-design-work-status.md`

     3. 10分超の場合の分割Prompt（Split Mode）

     * `work/{ユースケースID}/additional-azureservices-design-issue-prompt-<番号>.md`

   * 1.5 ## 7) 書き込み失敗（空ファイル）対策（固定）

     * 書き込み後に対象ファイルが空なら、内容を分割して追記（append）で再試行する。
     * 同じ失敗が続く場合は最大3回まで。改善不可なら status に原因と回避策を書く。

2. [Plan]作業手順の計画の立案

   * 2.1 各手順の作業手順の概算見積もりを行い、合計作業時間を算出する（正確性不要）。このPromptの生成時には見積もりは行わず、「見積もりをする」という指示に留める。

   * 2.2 合計の作業時間が10分を超えない場合は、このまま実行（「3. [Execution]」へ）。

   * 2.3 合計の作業時間が10分を超える場合は、作業を10分に収まりかつ並列実行可能な粒度に分割する。論理的に作業実行ができない場合には直列実行でも構わない。この場合は「3. [Execution]」をスキップする。

   * 2.4 ## 1) Planner（最初に必ず。形式は /AGENTS.md に準拠）

     * Plan の中に必ず以下の作業を含める:

       * 除外リスト作成（既存採用済み Azure サービスの抽出）
       * 外部依存・統合要件の抽出（サービス別）
       * 候補 Azure サービスの列挙（要件→候補）
       * 候補比較（最小：2案まで。不要なら単案で可）
       * 決定と根拠（Microsoft Learn 参照）
       * ファイル更新（additional / status）
       * 検証（差分確認、ファイル非空チェック）

   * 2.5 ## 6) 10分超の扱い（/AGENTS.md に従う＋この追加ルール）

     * 合計見積り > 10分なら Split Mode に移行し、サブPromptを複数作成する。
     * サブPromptは「サービスID単位」または「カテゴリ単位」で分割し、依存（除外リスト→抽出→決定→記録）を明記する。
     * サブPromptは `work/{ユースケースID}/additional-azureservices-design-issue-prompt-<番号>.md` に作成する。

3. [Execution] 作業の実行（[Plan]は含めない）

   * 3.1 入力ドキュメントの読解と前提整理

     * `usecase-description.md` / `service-list.md` / 各サービス定義書 を読み、対象サービスを把握する。
     * 「外部依存・統合」に関する記述を特定する（読めた範囲で進める）。

   * 3.2 確認質問（最大3）

     * 入力ドキュメントに「外部依存・統合」が存在しない/形式が不明な場合は、最大3つまで質問する。
     * ただし質問だけで停止せず、読めた範囲で暫定案を作り「要確認」と明記する。

   * 3.3 除外リスト作成（既存採用済み Azure サービスの抽出）

     * 抽出元: `AzureServices-services.md` / `AzureServices-data.md`
     * 既存採用済み（除外リストに載っているもの）は “追加提案” しない（ただし依存関係として参照は可）。

   * 3.4 外部依存・統合要件の抽出（サービス別）とカテゴリ正規化

     * 各サービスについて、外部依存・統合要件を「カテゴリ」に正規化する（例）：

       * 認証/認可、秘密管理、統合（API管理/イベント/メッセージング）、AI、検索、監視/ログ、ジョブ実行、ネットワーク境界 など

   * 3.5 候補 Azure サービスの列挙・比較・決定

     * ## 2) 選定ロジック（固定）

       * 1カテゴリにつき「第一候補」を1つ選び、必要なら「代替案」を最大1つだけ併記する。
       * 既存採用済みの Azure サービス（除外リストに載っているもの）は “追加提案” しない。
     * 候補比較（必要な場合のみ）: 最小2案まで。不要なら単案で可。

   * 3.6 Microsoft Learn 根拠の記載（必須）

     * ## 3) Microsoft Learn 根拠（必須）

       * 各採用（第一候補）には、Microsoft Learn を最低1件参照して以下を 3〜6行で書く：

         * 何ができるか（該当機能）
         * この要件にどう効くか（結び付け）
         * 採用理由（トレードオフ：運用/コスト/複雑性/セキュリティの観点で短く）
       * 根拠は Microsoft Learn の URL を必ず含める（推測で書かない）。URLが用意できない場合は「要確認」と明記する。

   * 3.7 成果物の作成（フォーマット固定）

     * ## 4) 追加サービス設計ファイルのフォーマット（固定）

       `docs/usecase/{ユースケースID}/AzureServices-services-additional.md` は以下で作る（章番号・構造は固定のため変更しない）：

       # Azure 追加サービス設計（{ユースケースID}）

       ## 1. 既存採用済み（除外）一覧

       * 抽出元: `AzureServices-services.md` / `AzureServices-data.md`
       * <サービス名/用途> ...

       ## 2. 追加提案（サービス別）

       ### {サービスID}-{サービス名}

       | 要件カテゴリ | 外部依存・統合要件（要約） | 採用Azureサービス（第一候補） | 使う機能/構成要点 | 代替案（任意） | 採用理由（短く） | 根拠（Microsoft Learn） |
       | ------ | ------------- | ----------------- | --------- | ------- | -------- | ------------------- |
       | 認証/認可  | ...           | ...               | ...       | ...     | ...      | タイトル + URL          |
       | 監視/ログ  | ...           | ...               | ...       | ...     | ...      | タイトル + URL          |

       * ルール:

         * 1要件カテゴリにつき1行（行が増えすぎる場合は主要カテゴリのみ）。
         * 「採用理由」は 2〜4行で、トレードオフを1点だけ入れる。
         * 根拠は Microsoft Learn の URL を必ず含める（推測で書かない）。

     * ## 5) 進捗ログのフォーマット（固定）

       `work/{ユースケースID}/additional-azureservices-design-work-status.md` には追記（append）で:

       * 日付（ISO）/実施内容/更新ファイル/次アクション/未解決質問
         を 5〜10行で書く（長文化しない）。

   * 3.8 検証（差分確認、ファイル非空チェック）

     * 更新ファイル（additional / status / split prompt を作成した場合はそれも含む）の差分を確認する。
     * 対象ファイルが空でないことをチェックする。

   * 3.9 空ファイル時の再試行

     * 対象ファイルが空の場合は「1.5 ## 7) 書き込み失敗（空ファイル）対策（固定）」に従う。

4. [Review]

   * 4.1 作業終了後に、目的を達成できているのか/整合性が取れているか等の観点でレビューし、問題点を10〜50個リストアップする。
   * 4.2 各問題点に対して解決策を立案し、その解決策を実行して、目的の達成できる成果物に修正する。
   * 4.3 レビューは異なる観点で3度行う（例：要件充足、形式/運用ルール遵守、根拠URLの妥当性/非捏造）。

5. [Finalize]

   * 5.1 レビュー後の最終版のみを作成して出力する（中間メモ/Plan/レビュー途中経過は含めない）。
