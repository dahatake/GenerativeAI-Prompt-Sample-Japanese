---
name: Architecture-Design-Step5-2-マイクロサービス定義書作成
description: 各サービスの詳細仕様を作成し、API・イベント・データ所有・セキュリティ・運用を包括的に定義します
tools: ["*"]
---

# 目的
ユースケースの全てのサービスを対象として、{マイクロサービス定義書}に準拠したマイクロサービスのドキュメントを作成してください。

- 作業の進捗状況を、`work/{ユースケースID}/service-doc-implementation-work-status.md`に日本語で追記してください。

- 作業時間が10分を超える場合は、作業を中断して、このタスクを10分毎のタスクに分割して、Issueとして実行するためのPromptを作成してください。それぞれのPromptを`work/microservice-detail-issue-prompt-<番号>.md`に日本語で追記してください。

- ファイルを作成する際に、1つのファイルに大きな文字列を書き込む際に、書き込み処理が失敗する場合があります。ファイルは作成されているのに内容がEmptyになっています。その場合は、書き込む文字列を分割して、複数の回数に書き込み処理を分割して、1つのファイルに出力をしてください。

## ユースケースID
- UC-xxx

## 参考ドキュメント
  - docs/usecase/{ユースケースID}/usecase-description.md
  - docs/usecase/{ユースケースID}/services/service-list.md
  - docs/usecase/{ユースケースID}/data-model.md
  - docs/usecase/{ユースケースID}/service-catalog.md
  - data/{ユースケースID}/sample-data.json

## 作成ファイル
  - docs/usecase/{ユースケースID}/services/{サービスID}-{サービス名}-description.md
    - {サービスID}は、各サービスのIDを設定する
    - {サービス名}は、各サービスの名称を設定する

## マイクロサービス定義書

### 1. **サービスメタ情報**

*   **サービス名／短縮名**：例）Template Service（TPL）
*   **概要（One-liner）**：何を「いつ・誰に・なぜ」提供するか。
*   **責務（Do）／非責務（Don't）**：境界の明示。承認ルーティング**実行**は非責務 等。
*   **利害関係者・主要ペルソナ**（任意）：管理者、部門管理者、申請者、監査。

### 2. **ビジネス能力・コンテキスト**

*   **対象ドメインとユースケースの対応表**：FR-002-01 下位要件とのトレーサビリティ。
*   **ライフサイクル**：ドラフト→レビュー→公開→廃止（状態と遷移イベント）。

### 3. **公開インターフェース（同期）**

*   **API スタイル**：REST（JSON/UTF‑8）（※GraphQL 等の場合は理由）。
*   **リソース一覧（概要）**：`/templates`、`/types`、`/fields`、`/diff`、`/preview` …（**動詞ではなく名詞**で統一）。
*   **操作粒度**：作成／取得／検索（フィルタ・ソート・ページング規約）／公開／廃止／差分取得／プレビュー。
*   **冪等性**：`Idempotency-Key` の扱い、重複作成の基準。
*   **エラー語彙（概要）**：`TPL-VAL-001 必須欠落`、`TPL-STATE-001 状態不正` などの**コード体系と責務境界**。

> ※後でコード生成するため、ここには**OpenAPI の骨子**（パス・ステータス・代表スキーマ名）だけを置く。

### 4. **公開インターフェース（非同期）**

*   **ドメインイベント（発行）**：`TEMPLATE.PUBLISHED`、`TEMPLATE.RETIRED` など。
    *   目的、発火条件、**最小ペイロード項目**（識別子、版、適用開始、破壊的変更フラグ 等）。
*   **サブスクライブ（受信）**：MDM 更新、承認ルール変更、インボイス検証結果 等。
*   **配信保証**：少なくとも 1 回／順序性／再送ポリシー（概念レベル）。

> ※後でコード生成するため、ここには**AsyncAPI の骨子**（チャンネル名・メッセージ名・キー属性）だけを置く。

### **イベントドリブンアーキテクチャ(EDA) 設計仕様

*   **Produced Events**
    *   名称：`TEMPLATE.PUBLISHED`
        *   **スキーマ参照**：`registry://template/published@v1`
        *   **パーティションキー**：`templateId`
        *   **配信保証**：At-least-once
        *   **順序性**：同一 `templateId` 内で保証
        *   **冪等性戦略**：`eventId` + 重複検知ストア（TTL=24h）
        *   **Outbox戦略**：DBトランザクション＋非同期パブリッシュ
        *   **保持期間**：90日
        *   **PII**：低（IDのみ）
    *   名称：`TEMPLATE.RETIRED`（同様の属性）

*   **Consumed Events**
    *   名称：`MDM.UPDATED`
        *   **ハンドラ**：`OnMdmUpdatedSyncTemplate`
        *   **再試行ポリシー**：指数バックオフ＋ジッタ
        *   **DLQ**：`tpl.mdm-updated.dlq`
        *   **順序要件**：なし（冪等性で吸収）

*   **SAGA参加ロール**
    *   サガ名：`template-lifecycle`
        *   **役割**：`participant`
        *   **補償イベント**：`TEMPLATE.ROLLBACK`（公開失敗時）

*   **イベントスキーマ互換性**
    *   **規約**：後方互換（フィールド追加のみ）
    *   **バージョニング**：`schemaVersion` 属性必須

*   **セキュリティ**
    *   **認証/認可**：トピックACL、JWTスコープ `tpl:publish`
    *   **暗号化**：TLS転送、KMS保存
    *   **データ最小化**：公開イベントはIDのみ

*   **可観測性**
    *   **Trace Context**：W3C Trace IDをイベントに伝播
    *   **メトリクス**：処理遅延、DLQ件数、重複率
    *   **ログ**：構造化ログ＋`eventId`相関

*   **運用**
    *   **DLQ処理**：隔離→原因分類→再投入
    *   **リプレイ戦略**：イベントストリーム再生で投影再構築
    *   **保持/コンパクション**：90日＋最新状態のみ圧縮

### 5. **データ所有・モデル（概念）**

*   **主エンティティと所有者**：Template（本サービス所有）、RequestType（同）、AttachmentPolicy（同） 等。
*   **整合性・一意性ルール**：同一 `typeId` で同時点に有効な版は1つ、破壊的変更は新規版 等。
*   **データ分類／個人情報**：PII/非PII、電帳法検索キーの取り扱い。
*   **マルチテナンシ／スコープ**：全社／部門／ロール／属性（可視性の粒度）。

### 6. **セキュリティ・権限**

*   **認証**：OIDC/SSO（MFA 前提）。
*   **認可**：RBAC/ABAC（属性例：部門 ID、役職、委任期間）。
*   **暗号化**：転送中 TLS、保存時 KMS、添付はオブジェクトストレージのサーバサイド暗号化。
*   **監査**：操作（作成／編集／公開／廃止／ロールバック）の**不可改ざん記録**（何を・誰が・いつ・どこから）。

### 7. **外部依存・統合**

*   **依存先と契約**：
    *   MDM/HR（組織・職位・権限・委任）
    *   承認エンジン（RuleSet 参照のみ）
    *   電帳法対応ストレージ／タイムスタンプ
    *   インボイス検証 API
    *   ERP/会計/契約台帳/DWH
*   **フォールバック戦略**：外部検証障害時は暫定許可→**後続検証キュー**、時間切れ時のポリシー。

### 8. **状態遷移・ビジネスルール**

*   **状態機械（概念図）**：Draft → InReview → Published → Retired（RollBack 可否）。
*   **条件分岐の原則**：金額・カテゴリ・海外判定等に基づく動的表示／必須化の**安全側フォールバック**。
*   **公開可否ゲート**：電帳法検索キーが欠落するテンプレは公開不可 等。

### 9. **非機能・SLO（概念）**

*   **可用性／パフォーマンス目安**：例）p50/p95 レイテンシ、同時編集想定、イベント伝播遅延上限。
*   **スケーラビリティ**：読み主体（一覧・プレビュー）最適化、書き（公開）時の直列化。
*   **運用監視**：メトリクス（差戻し率、滞留時間、公開後エラー率）、トレース、構成変更監視。

### 10. **バージョニング／互換性**

*   **API 版付け**：`/api/v1/...` の原則、後方互換の維持と**廃止告知期間**。
*   **テンプレ版と適用範囲**：新規起票には最新版、既存案件は旧版維持／ドラフトの自動マイグレーション方針（案内のみ、強制なし）。
*   **イベント版付け**：メッセージの `schemaVersion` と互換規約。

### 11. **エラー・レート制御・再試行**

*   **エラー体系（概要）**：`TPL-VAL-xxx`（検証）、`TPL-STATE-xxx`（状態）、`TPL-API-xxx`（外部障害）など**命名規約**。
*   **レート制限**：管理操作（公開・廃止）は保守的、読み取りは緩め。
*   **再試行ポリシー**：クライアント／サーバの責務分界、**冪等性キー**利用時の再送許容。

### 12. **設定・フラグ**

*   **機能フラグ**：ローカライズ有効化、OCR 有効化、破壊的変更ガード。
*   **構成キー**：外部 API タイムアウト、最大添付サイズ、OCR リトライ回数（値はここでは**未記載**）。

### 13. **移行・初期データ（任意）**

*   **初期テンプレの投入計画**、旧システムからの**読み替え原則**、識別子のマッピング方針。

### 14. **テスト指針（概念）**

*   **契約テスト**（Provider/Consumer）、**状態遷移テスト**、**ローカライズの可用性テスト**、**監査改ざん検知テスト**。
*   **テストデータ原則**：サンプルテンプレと最小必須証憑。

### 15. **運用・リリース（概念）**

*   **デプロイ戦略**：ローリング／カナリア（公開・廃止の**時間指定**に対応）。
*   **ロールバック**：API とデータの整合を保つための**版単位**ロールバック手順（概念）。
*   **通知・チェンジマネジメント**：リリースノート、影響分析、対象ユーザへの配布ポリシー。

### 16. **リスク・オープン課題**

*   例：外部検証 API の SLA 未定義、MDM の属性欠落、部門差分の継承衝突 等。

## 17. **画面・操作・API・イベント マッピング**

*   **目的**：UI（画面）とマイクロサービスの責務を明確化し、疎結合な設計を担保する。
*   **マッピング表**：
*   **原則**：
    *   1画面＝1主要サービス（UIロジックは集約しない）
    *   複数サービスを呼ぶ場合は\*\*BFF（Backend for Frontend）\*\*でオーケストレーション
    *   画面IDはFRDやUI設計書とトレーサブルに

### 付録 A（コード生成用の"骨子"を添付）

*   **OpenAPI（スケルトン）**：パス・メソッド・代表スキーマ名のみ。
*   **AsyncAPI（スケルトン）**：チャンネル名・イベント名・キー属性のみ。
*   **JSON Schema（概念版）**：`Template`, `FieldDefinition`, `AttachmentPolicy` の最低限属性。
*   **用語集／語彙**：ラベル、状態、エラーコードの辞書。
