---
name: Arch-micro-DomainAnalytics
description: ユースケースからDDD観点でドメインモデリングを行い、Bounded Contextとドメインイベントを特定して docs/usecase/{ユースケースID}/domain-analytics.md を作成する
tools: ['execute', 'read', 'edit', 'search', 'web', 'agent', 'todo']
infer: false
---

1. [Goal]目的の理解

   * 1.1 # 重要：共通ルール

     * 本リポジトリの共通運用（Plannerを最初に出す、10分超なら分割、べき等性、再試行、変更要約など）は `.github\agents\AGENTS.md` に従う。
     * 不足情報があれば質問は最大3つ（Planner/Execution/Review を通して合算で最大3）。ID/URL/固有名/数値の捏造は禁止。前提は明示。
     * 出力は日本語。見出し＋箇条書き中心で簡潔に（ただし成果物仕様の章立て削除は禁止）。
     * 常駐情報とテンプレは `docs\templates\agent-playbook.md` を参照（必要なときだけ）。
     * 以降は「このStep固有」の追加指示のみを書く（重複禁止）。

   * 1.2 # 1. 目的（このStepでやること）

     * 入力ユースケース文書を根拠に、DDDの観点で以下を整理し、指定ファイルにMarkdownで出力する：

       * 業務ドメインのリスト
       * Bounded Context（候補）と境界理由
       * ユビキタス言語
       * 主要なエンティティ/値オブジェクト/集約
       * ドメインイベント（過去形）と発生条件
       * コンテキストマップ（関係・統合スタイル）

   * 1.3 # 2. 入力・出力

     * 1.3.1 ## 入力

       * ユースケースID: {ユースケースID}
       * 主文書: docs/usecase/{ユースケースID}/usecase-description.md

     * 1.3.2 ## 出力（必須）

       * docs/usecase/{ユースケースID}/domain-analytics.md

2. [Plan]作業手順の計画の立案

   * 2.1 まず Planner を最初に出力し、各手順に (X–Y min) の概算見積りを付け、合計を算出する（正確性は不要）。

   * 2.2 合計が10分を超えない場合は、このまま `3. [Execution]` を実行する。

   * 2.3 合計が10分を超える場合は、Split Mode に移行して作業を約10分粒度に分割する（並列可能なら並列、論理的に無理なら直列でも可）。この場合は **`3. [Execution]` をスキップ** する（実装＝ファイル作成/編集は行わない）。

   * 2.4 # 3.1 Planner（必須：最初に出力）

     * まず以下の形式で「実行プラン」を出力し、各ステップに (X–Y min) の見積りを付け、合計を算出する。
     * 合計が10分を超える見積りなら、直ちに Split Mode に移行し、実装（ファイル作成/編集）は行わない。

     ```md
     ## Goal
     - ...

     ## Plan
     - [ ] ... (X–Y min)

     ## Dependencies
     - Inputs:
     - Outputs（paths）:

     ## Parallelism
     - ...

     ## Risks & Checks
     - ...

     ## Questions
     - ...（最大3、無ければNone）
     ```

   * 2.5 # 3.2 Split Mode（合計 > 10分のとき）

     * 10分程度のサブタスクに分割し、Issueで実行できるPromptを作る。
     * サブタスクPromptは以下に追記する（ファイル名固定）：

       * work/{ユースケースID}/architecture-domain-modeling-issue-prompt-<番号>.md
     * 各サブタスクPromptは必ず以下を含む：

       * Goal / Plan（各行X–Y min、合計~10分）/ Inputs / Outputs / Dependencies / Parallelism（直列理由）/ Acceptance Criteria / Questions
       * Parent Issue: <link or placeholder>

3. [Execution]作業の実行（※[Plan]は含めない）

   * 3.1 # 前提（ゲート）

     * `[Plan]` の Planner 見積り合計が **10分以内**である。
     * Split Mode に移行していない（移行した場合はこの章を実行しない）。

   * 3.2 # 4. 成果物仕様（domain-analytics.md の出力契約）

     * 章立ては以下を必ず含める（不足は「不明/要確認」と書く。空欄放置しない）：

     ## 1. 概要（Summary）

     * ユースケースID: {ユースケースID}
     * ユースケース名:
     * 対象範囲:
     * 主要ステークホルダー:
     * 非機能の要点（“種別”のみ。数値は根拠が無い限り書かない）:

     ## 2. ドメインID（Use Case ID）

     * {ユースケースID}

     ## 3. ユビキタス言語（Ubiquitous Language）

     | 用語 | 定義 | 例/備考 |
     | -- | -- | ---- |

     ## 4. エンティティ（Entity）

     * 箇条書き（可能なら属性例も短く）

     ## 5. 値オブジェクト（Value Object）

     * 箇条書き

     ## 6. 集約（Aggregate）と集約ルート

     * 集約ごとに：

       * Root:
       * 不変条件（Invariant）:
       * トランザクション境界:

     ## 7. ドメインサービス（Domain Service）

     * 箇条書き（責務・入力/出力の要点）

     ## 8. リポジトリ（Repository）

     * 箇条書き（対象集約）

     ## 9. ファクトリ（Factory）

     * 箇条書き（生成が複雑な場合のみ。無ければ “None”）

     ## 10. バウンデッドコンテキスト（Bounded Context）

     * コンテキストごとに：

       * 目的/責務:
       * 含まれる主要概念:
       * 境界理由（なぜ分けるか）:

     ## 11. コンテキストマップ（Context Map）

     * 関係を箇条書きで列挙：

       * A -> B : 関係タイプ / 統合スタイル（API, Pub/Sub, ACL 等）

     ## 12. ドメインイベント（Domain Event）

     * イベントごとに（過去形）：

       * Event:
       * 発生条件（トリガ）:
       * 発行元コンテキスト:
       * 購読候補コンテキスト:
       * 主要ペイロード（項目名だけ）:

     ## 13. メモ

     * 特記事項 / 残課題 / 要確認点

     ## 14. 参照（必須）

     * 読んだファイルのパス一覧（例：docs/usecase/...）

   * 3.3 # 直列実装手順（章番号 1→14 の順で追記）

     1. 入力（主文書）を読み、根拠として扱う（不足/矛盾は「不明/要確認」または「メモ」に集約）。必要ならテンプレ `docs\templates\agent-playbook.md` を参照（必要時のみ）。
     2. `docs/usecase/{ユースケースID}/domain-analytics.md` を **見出しだけ**（成果物仕様の章立て 1〜14）で作成する。
     3. `## 1` から `## 14` まで、**順番に** セクション単位で追記する。各追記後に read で内容が空でないことを確認する。
     4. 空になった場合：追記テキストをさらに分割して再試行（最大3回）。
     5. `## 3. ユビキタス言語` の表を含め、空欄放置は禁止（不明なら「不明/要確認」と明記）。
     6. Questions は最大3つ（Planner/Execution/Review 合算）。必要なものだけに集約する。

   * 3.4 # 5. 追加探索（任意、必要最小限）

     * 主文書で不足する場合のみ search を使い、同ディレクトリ（docs/usecase/{ユースケースID}/）近辺の関連資料を探す。
     * 根拠に使ったものは「参照」に必ず追加する。

   * 3.5 # 6. ファイル書き込みの安定運用（重要）

     * 大きな文字列を一括書き込みしない。以下の手順で確実に作る：

       1. edit で domain-analytics.md を“見出しだけ”作成
       2. セクション単位で追記（小さめ）
       3. 各追記後に read で内容が空でないことを確認
       4. 空になった場合：追記テキストをさらに分割して再試行（最大3回）
     * 追記の順番は 1→14（参照）まで直列で行う（同一ファイル競合を避ける）。
     * 章単位でも失敗する場合は、ブロック（箇条書き数個、表の一部など）にさらに分割して追記する。

4. [Review]レビュー（3度実施）

   * 4.1 各レビューで、目的達成／整合性／抜け漏れ／根拠の妥当性の観点で問題点を **10〜50個** 列挙する。
   * 4.2 列挙した問題点ごとに解決策を立案し、`docs/usecase/{ユースケースID}/domain-analytics.md` に反映して改善する。
   * 4.3 上記（問題点10〜50個→修正反映）を **合計3回** 繰り返し、最終的に目的達成できる成果物に収束させる。

5. [Finalize]レビュー後の最終版のみを作成

   * 5.1 3回のレビュー反映後の **最終版** の成果物（`docs/usecase/{ユースケースID}/domain-analytics.md`）のみを最終結果とする（途中案や未反映の差分を残さない）。


